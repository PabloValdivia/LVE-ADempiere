<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="AnalyticalInventory" pageWidth="612" pageHeight="792" whenNoDataType="BlankPage" columnWidth="535" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="e1c96eec-08a1-4344-8833-51631677ce88">
	<property name="ireport.zoom" value="3.446229739767921"/>
	<property name="ireport.x" value="1274"/>
	<property name="ireport.y" value="311"/>
	<parameter name="AD_Org_ID" class="java.math.BigDecimal">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="M_Warehouse_ID" class="java.math.BigDecimal">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="M_Locator_ID" class="java.math.BigDecimal">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="M_Product_Category_ID" class="java.math.BigDecimal">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="M_Product_ID" class="java.math.BigDecimal">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="MovementDate1" class="java.sql.Timestamp">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="MovementDate2" class="java.sql.Timestamp">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<parameter name="CURRENT_LANG" class="java.lang.String">
		<defaultValueExpression><![CDATA[]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[SELECT
    wh.M_WareHouse_ID,
    COALESCE(wh.Value,'') AS WareHouseValue,
    COALESCE(wh.Name, '') AS WareHouseName,
    COALESCE(wh.Description,'') AS WareHouseDescription,
    ml.M_Locator_ID,
    COALESCE(ml.Value,'') As LocatorValue,
    ml.X,
    ml.Y,
    ml.Z,
    mp.M_Product_ID,
    COALESCE(mp.Value,'') ProductValue,
    COALESCE(mp.Name,'') AS ProductName,
    COALESCE(mp.Description,'') as ProductDescription,
    MT.MovementDate,
    COALESCE(mtinit.MovementQty, 0) AS QtyInitial,
    CASE WHEN mt.MovementQty < 0 THEN Abs(mt.MovementQty) ELSE NULL END AS QtyOutGoing,
    CASE WHEN mt.MovementQty > 0 THEN mt.MovementQty ELSE NULL END AS QtyIncoming,
    COALESCE(COALESCE(COALESCE(mio.DocumentNo,MI.DocumentNO),mm.DocumentNo),mpr.Name) AS DocumentNo,
    mt.MovementQty,
    COALESCE(ao.Name,'') AS OrgName,
    COALESCE(ao.Value,'') AS OrgKey,
    TO_Char($P{MovementDate1}::timestamp,'DD/MM/YYYY') MovementDate1,
    TO_Char($P{MovementDate2}::timestamp,'DD/MM/YYYY') MovementDate2,
    --ref.Name AS ReferenceName,
    ac.Name AS Client,
    mpc.Name AS ProductCategoryName,
 (Select COALESCE(rft.Name,rf.Name) rName
	 From AD_Reference r
	 INNER JOIN AD_Ref_List rf ON r.AD_Reference_ID = rf.AD_Reference_ID
	 INNER JOIN AD_Ref_List_Trl rft ON ( rf.AD_Ref_List_ID=rft.AD_Ref_List_ID AND rft.AD_Language = $P{CURRENT_LANG}
	 )
	 WHERE r.AD_Reference_ID=189
	 AND rf.Value = mt.MovementType ) ReferenceName

FROM
AD_Client ac
INNER JOIN AD_Org ao ON ac.AD_Client_ID = ao.AD_Client_ID
INNER JOIN M_Transaction mt ON ao.AD_Org_ID = mt.AD_Org_ID
INNER JOIN M_Product mp ON mt.M_Product_ID= mp.M_Product_ID
INNER JOIN M_Locator ml ON ml.M_Locator_ID=mt.M_Locator_ID
INNER JOIN M_WareHouse wh ON wh.M_WareHouse_ID = ml.M_WareHouse_ID
LEFT JOIN M_InoutLine miol ON miol.M_InoutLine_ID=mt.M_InoutLine_ID
LEFT JOIN M_Inout mio ON miol.M_Inout_Id = mio.M_Inout_Id
LEFT JOIN M_InventoryLine mil ON mil.M_InventoryLine_Id=mt.M_InventoryLine_Id
LEFT JOIN M_Inventory mi ON mi.M_Inventory_Id=mil.M_Inventory_Id
LEFT JOIN M_MovementLine mml ON mml.M_MovementLine_ID = mt.M_MovementLine_ID
LEFT JOIN M_Movement mm ON mm.M_Movement_ID = mml.M_Movement_ID
LEFT JOIN M_ProductionLine mpl ON mpl.M_ProductionLine_ID = mt.M_ProductionLine_ID
LEFT JOIN M_ProductionPlan mpp ON mpp.M_ProductionPlan_ID = mpl.M_ProductionPlan_ID
LEFT JOIN M_Production mpr ON mpr.M_Production_ID = mpp.M_Production_ID
LEFT JOIN M_Product_Category mpc ON mpc.M_Product_Category_ID = mp.M_Product_Category_ID
LEFT JOIN (SELECT M_Locator_ID,M_Product_ID,Sum(MovementQty) AS MovementQty
            FROM
            M_Transaction
            WHERE MovementDate < $P{MovementDate1} OR COALESCE($P{MovementDate1}, Current_Timestamp) = Current_Timestamp
            GROUP BY M_Locator_ID,M_Product_ID) AS mtinit ON mtinit.M_Product_ID = mt.M_Product_ID  AND mtinit.M_Locator_ID= mt.M_Locator_ID
WHERE (ao.AD_Org_ID = $P{AD_Org_ID} OR $P{AD_Org_ID} IS NULL)
    AND (wh.M_WareHouse_ID = $P{M_Warehouse_ID} OR $P{M_Warehouse_ID} IS NULL)
    AND (mp.M_Product_ID = $P{M_Product_ID} OR $P{M_Product_ID} IS NULL)
    AND (ml.M_Locator_ID = $P{M_Locator_ID} OR $P{M_Locator_ID} IS NULL)
    AND (mp.M_Product_Category_ID = $P{M_Product_Category_ID} OR $P{M_Product_Category_ID} IS NULL)
    AND (mt.MovementDate >= $P{MovementDate1} OR COALESCE($P{MovementDate1}, Current_Timestamp) = Current_Timestamp)
    AND (mt.MovementDate <= $P{MovementDate2} OR COALESCE($P{MovementDate2}, Current_Timestamp) = Current_Timestamp)

ORDER BY wh.M_WareHouse_ID, ml.M_Locator_ID, mp.M_Product_ID, mt.MovementDate]]>
	</queryString>
	<field name="m_warehouse_id" class="java.math.BigDecimal"/>
	<field name="warehousevalue" class="java.lang.String"/>
	<field name="warehousename" class="java.lang.String"/>
	<field name="warehousedescription" class="java.lang.String"/>
	<field name="m_locator_id" class="java.math.BigDecimal"/>
	<field name="locatorvalue" class="java.lang.String"/>
	<field name="x" class="java.lang.String"/>
	<field name="y" class="java.lang.String"/>
	<field name="z" class="java.lang.String"/>
	<field name="m_product_id" class="java.math.BigDecimal"/>
	<field name="productvalue" class="java.lang.String"/>
	<field name="productname" class="java.lang.String"/>
	<field name="productdescription" class="java.lang.String"/>
	<field name="movementdate" class="java.sql.Timestamp"/>
	<field name="qtyinitial" class="java.math.BigDecimal"/>
	<field name="qtyoutgoing" class="java.math.BigDecimal"/>
	<field name="qtyincoming" class="java.math.BigDecimal"/>
	<field name="documentno" class="java.lang.String"/>
	<field name="movementqty" class="java.math.BigDecimal"/>
	<field name="orgname" class="java.lang.String"/>
	<field name="orgkey" class="java.lang.String"/>
	<field name="movementdate1" class="java.lang.String"/>
	<field name="movementdate2" class="java.lang.String"/>
	<field name="client" class="java.lang.String"/>
	<field name="productcategoryname" class="java.lang.String"/>
	<field name="referencename" class="java.lang.String"/>
	<variable name="MovementQtyAccumulated" class="java.math.BigDecimal" resetType="Group" resetGroup="M_Product_ID" calculation="Sum">
		<variableExpression><![CDATA[$F{movementqty}]]></variableExpression>
	</variable>
	<group name="M_WareHouse_ID">
		<groupExpression><![CDATA[$F{m_warehouse_id}]]></groupExpression>
		<groupHeader>
			<band height="12">
				<staticText>
					<reportElement x="0" y="0" width="66" height="12" uuid="b927e32a-9ed7-4405-acbf-ea6ba3b05192"/>
					<textElement verticalAlignment="Middle">
						<font size="9" isBold="true" isItalic="true" isUnderline="false"/>
					</textElement>
					<text><![CDATA[Almacen:]]></text>
				</staticText>
				<textField>
					<reportElement x="66" y="0" width="506" height="12" uuid="3f991196-8266-490c-a6b3-1c0d4b15a1ea"/>
					<textElement verticalAlignment="Middle">
						<font size="9" isBold="false" isItalic="true" isUnderline="false"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{warehousevalue} + " " + $F{warehousename}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
	</group>
	<group name="M_Locator_ID">
		<groupExpression><![CDATA[$F{m_locator_id}]]></groupExpression>
		<groupHeader>
			<band height="13">
				<textField>
					<reportElement x="66" y="1" width="506" height="12" uuid="3f991196-8266-490c-a6b3-1c0d4b15a1ea"/>
					<textElement verticalAlignment="Middle">
						<font size="9" isBold="false" isItalic="true" isUnderline="false"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{locatorvalue}]]></textFieldExpression>
				</textField>
				<staticText>
					<reportElement x="0" y="1" width="66" height="12" uuid="b927e32a-9ed7-4405-acbf-ea6ba3b05192"/>
					<textElement verticalAlignment="Middle">
						<font size="9" isBold="true" isItalic="true" isUnderline="false"/>
					</textElement>
					<text><![CDATA[Localizador:]]></text>
				</staticText>
			</band>
		</groupHeader>
	</group>
	<group name="M_Product_ID">
		<groupExpression><![CDATA[$F{m_product_id}]]></groupExpression>
		<groupHeader>
			<band height="13">
				<textField>
					<reportElement x="0" y="0" width="486" height="12" uuid="42d2c686-b449-450c-8e65-9bada46cc43f"/>
					<box>
						<bottomPen lineWidth="0.5"/>
					</box>
					<textElement verticalAlignment="Middle">
						<font size="9" isBold="true" isItalic="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{productvalue} + " - " + $F{productname}]]></textFieldExpression>
				</textField>
				<textField pattern="#,##0">
					<reportElement x="486" y="0" width="86" height="12" uuid="3862bfe8-c26a-429e-8969-77e2cbc84751"/>
					<box>
						<bottomPen lineWidth="0.5"/>
					</box>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font size="9" isBold="true" isItalic="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{qtyinitial}]]></textFieldExpression>
				</textField>
			</band>
		</groupHeader>
		<groupFooter>
			<band height="16">
				<textField>
					<reportElement x="0" y="1" width="278" height="12" uuid="47f2f288-121d-431e-9cac-f05c9bcba867"/>
					<textElement verticalAlignment="Middle">
						<font size="9" isBold="true" isItalic="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{productname}]]></textFieldExpression>
				</textField>
				<textField pattern="#,##0">
					<reportElement x="486" y="0" width="86" height="12" uuid="76554311-2503-41ab-b157-f9b18d11c9a3"/>
					<textElement textAlignment="Right" verticalAlignment="Middle">
						<font size="9" isBold="true"/>
					</textElement>
					<textFieldExpression><![CDATA[$F{qtyinitial}.add( $V{MovementQtyAccumulated} )]]></textFieldExpression>
				</textField>
			</band>
		</groupFooter>
	</group>
	<pageHeader>
		<band height="113">
			<textField>
				<reportElement x="176" y="1" width="220" height="83" uuid="2c5cb4b3-244b-4f25-a4bc-1b931e89f9d9"/>
				<textElement textAlignment="Center" markup="none">
					<font size="14" isBold="true"/>
				</textElement>
				<textFieldExpression><![CDATA["Variación Diaria de Inventario\n\"" + $F{client} + "\""]]></textFieldExpression>
			</textField>
			<textField isStretchWithOverflow="true" isBlankWhenNull="true">
				<reportElement stretchType="RelativeToBandHeight" x="0" y="1" width="160" height="12" uuid="63011de2-e6e1-4337-af62-b0e250b0e679"/>
				<textElement>
					<font size="7"/>
				</textElement>
				<textFieldExpression><![CDATA[($P{AD_Org_ID} == null ? "" :"Organización = " + $F{orgkey} + " - " + $F{orgname}  + "\n") +
($P{M_Warehouse_ID} == null ? "" :"Almacen = " + $F{warehousevalue}  + " - " + $F{warehousename} + "\n") +
($P{M_Locator_ID} == null ? "" :"Localizador = " + $F{locatorvalue} + "\n") +
($P{M_Product_Category_ID} == null ? "" :"Categoría de Producto = " + $F{productcategoryname} + "\n") +
($P{M_Product_ID} == null ? "" :"Producto = " + $F{productvalue} + " - " + $F{productname} + "\n") +
($P{MovementDate1} ==null ? "" :"Fecha de Movimiento >=" + $F{movementdate1} + "\n") +
($P{MovementDate2} ==null ? "" :"Fecha de Movimiento <=" + $F{movementdate2} + "\n")]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="465" y="16" width="41" height="12" uuid="38ee2fe7-d733-4c1f-adaf-c02440b656ce"/>
				<textElement verticalAlignment="Middle">
					<font size="7" isBold="true" isItalic="true"/>
				</textElement>
				<text><![CDATA[Hora:]]></text>
			</staticText>
			<textField pattern="dd/MM/yyyy">
				<reportElement x="510" y="1" width="61" height="12" uuid="2fb655c9-cf27-4d44-88d5-b6dbe8caa40e"/>
				<textElement verticalAlignment="Middle">
					<font size="7"/>
				</textElement>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="465" y="1" width="41" height="12" uuid="8281fd58-bba9-4af3-915c-adc8556ad40b"/>
				<textElement verticalAlignment="Middle">
					<font size="7" isBold="true" isItalic="true"/>
				</textElement>
				<text><![CDATA[Fecha:]]></text>
			</staticText>
			<textField evaluationTime="Report">
				<reportElement x="510" y="31" width="61" height="12" uuid="ba8559c3-0c8b-4208-85ac-c30ba495d920"/>
				<textElement verticalAlignment="Middle">
					<font size="7"/>
				</textElement>
				<textFieldExpression><![CDATA[$V{PAGE_NUMBER}]]></textFieldExpression>
			</textField>
			<textField pattern="h.mm.ss a">
				<reportElement x="510" y="16" width="61" height="12" uuid="e801fdd3-e908-4152-9c95-ca1a41315c2d"/>
				<textElement verticalAlignment="Middle">
					<font size="7"/>
				</textElement>
				<textFieldExpression><![CDATA[new java.util.Date()]]></textFieldExpression>
			</textField>
			<staticText>
				<reportElement x="465" y="31" width="41" height="12" uuid="7f78f6dd-b7cb-4c93-aa51-7dacce5974c7"/>
				<textElement verticalAlignment="Middle">
					<font size="7" isBold="true" isItalic="true"/>
				</textElement>
				<text><![CDATA[Paginas:]]></text>
			</staticText>
			<staticText>
				<reportElement x="0" y="101" width="66" height="12" uuid="d97743ed-4a9d-47f6-9611-69bf8d1a4881"/>
				<box>
					<bottomPen lineWidth="0.5"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="9" isBold="true"/>
				</textElement>
				<text><![CDATA[Fecha]]></text>
			</staticText>
			<staticText>
				<reportElement x="66" y="101" width="252" height="12" uuid="44625584-1702-4fdd-9bae-94fd76bc8853"/>
				<box>
					<bottomPen lineWidth="0.5"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="9" isBold="true"/>
				</textElement>
				<text><![CDATA[Documento]]></text>
			</staticText>
			<staticText>
				<reportElement x="318" y="101" width="84" height="12" uuid="9ea48a4f-80cb-4d46-8552-0886354bc4ff"/>
				<box>
					<bottomPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="9" isBold="true"/>
				</textElement>
				<text><![CDATA[Entradas]]></text>
			</staticText>
			<staticText>
				<reportElement x="402" y="101" width="84" height="12" uuid="fdc67b60-a083-41be-96d4-16c278fd90b0"/>
				<box>
					<bottomPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="9" isBold="true"/>
				</textElement>
				<text><![CDATA[Salidas]]></text>
			</staticText>
			<staticText>
				<reportElement x="486" y="101" width="86" height="12" uuid="9e901e6d-e92e-4e0e-967d-a54da9835841"/>
				<box>
					<bottomPen lineWidth="0.5"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="9" isBold="true"/>
				</textElement>
				<text><![CDATA[Saldo]]></text>
			</staticText>
		</band>
	</pageHeader>
	<detail>
		<band height="13">
			<textField pattern="dd/MM/yyyy">
				<reportElement x="0" y="0" width="66" height="12" uuid="029ba0c6-61d0-4168-a8fd-f47f84e8a6c0"/>
				<box>
					<bottomPen lineWidth="0.25"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{movementdate}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="true">
				<reportElement x="318" y="0" width="84" height="12" uuid="2f4dec7c-036a-4acf-905e-d2b0b4ebc011"/>
				<box>
					<bottomPen lineWidth="0.25"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{qtyincoming}]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0" isBlankWhenNull="true">
				<reportElement x="402" y="0" width="84" height="12" uuid="716aa5d9-f4f1-4407-82da-edd6c2981a28"/>
				<box>
					<bottomPen lineWidth="0.25"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{qtyoutgoing}]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement x="66" y="0" width="252" height="12" uuid="82088f21-1348-4442-bb28-024d139616b9"/>
				<box>
					<bottomPen lineWidth="0.25"/>
				</box>
				<textElement verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{referencename} + " (" +$F{documentno} + ")"]]></textFieldExpression>
			</textField>
			<textField pattern="#,##0">
				<reportElement x="486" y="0" width="86" height="12" uuid="76554311-2503-41ab-b157-f9b18d11c9a3"/>
				<box>
					<bottomPen lineWidth="0.25"/>
				</box>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{qtyinitial}.add( $V{MovementQtyAccumulated} )]]></textFieldExpression>
			</textField>
		</band>
	</detail>
</jasperReport>
